{% load static %}
<!DOCTYPE html>
<html lang="en">
  <link rel="stylesheet" type="text/css" href="{% static './css/cssTabla.css' %}" />
  <script src="{% static 'js/session_monitor.js' %}"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var idleTime = 0;

        function timerIncrement() {
            idleTime++;
            if (idleTime > 1) { // 1 minuto
                window.location.href = "{% url 'cerrar_sesion_redirect_e' %}";
            }
        }

        $(document).ready(function () {
            // Increment the idle time counter every minute.
            var idleInterval = setInterval(timerIncrement, 10000); // 1 minuto

            // Reset the idle timer on mouse movement or key press.
            $(this).mousemove(function (e) {
                idleTime = 0;
                keepSessionAlive();
            });
            $(this).keypress(function (e) {
                idleTime = 0;
                keepSessionAlive();
            });
        });

        function keepSessionAlive() {
            $.get("{% url 'keep_session_alive' %}");
        }
        
        window.addEventListener('popstate', function(event) {
            // Prevenir el comportamiento por defecto
            event.preventDefault();

            // Enviar la solicitud POST para cerrar sesión
            fetch('{% url "cerrar_sesion_redirect_e" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({})
            }).then(response => {
                if (response.ok) {
                    // Redirigir a la página de inicio de sesión después de cerrar sesión
                    window.location.href = '{% url "loginEmpresa" %}';
                }
            }).catch(error => {
                console.error('Error al cerrar sesión:', error);
                // Opcional: Manejar errores si es necesario
            });
        });
    </script>
  <head>
    <meta charset="UTF-8" />
    <title>Empresas</title>
  </head>
  <body>
    {% if request.session.estadoSesion %}
      {% if request.session.permisos == 'Contador' or request.session.permisos == 'Auxiliar Contable' or request.session.permisos == 'RRHH' %}
        <h1>Bienvenido {{ independi.primer_nombre }}</h1>
        <h1>Lista de Empresas</h1>
        <table border="1">
          <tr>
            <th>Nit</th>
            <th>Razon Social</th>
            <th>Telefono Entidad</th>
            <th>Correo Entidad</th>
            <th>Imagen</th>
            <th>Accion</th>
          </tr>
          {% for empresa in get_empresa %}
            <tr>
              <td>{{ empresa.nit }}</td>
              <td>{{ empresa.razon_social }}</td>
              <td>{{ empresa.telefono_entidad }}</td>
              <td>{{ empresa.correo_entidad }}</td>

              <td>
                <img src="{{ empresa.imagen.url }}" alt="Imagen" width="50" />
              </td>
              {% if request.session.permisos == 'Contador' or request.session.permisos == 'Auxiliar Contable' %}
              <td><a class="btn btn-warning" href="{% url 'editarEmpresa' empresa.nit %}">EDITAR</a>
              <a class="btn btn-warning" href="{% url 'eliminarempre' empresa.nit %}">Eliminar</a>
              <a class="btn btn-warning" href="{% url 'ListarEmpleados' empresa.nit %}">Nomina Personal</a>
              {% endif %}
              {% if request.session.permisos == 'RRHH' %}
              <a class="btn btn-warning" href="{% url 'ListarEmpleados' empresa.nit %}">Gestionar Personal</a></td> </tr>
              {% endif %}
            {% endfor %}
        </table>
      {% else %}
        <h1>El usuario no tiene permisos</h1>
      {% endif %}
    {% else %}
      <h1>El usuario no ha iniciado sesión</h1>
    {% endif %}
  </body>
  
</html>
